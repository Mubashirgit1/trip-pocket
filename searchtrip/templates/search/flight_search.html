{% extends "base.html" %}

{% block content %}
<!-- index.html content starts here -->
{% load static %}

<style>
  .form-select {
    border: 2px solid #007BFF;
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 1rem;
    font-weight: 500;
    color: #333;
    background-color: #fff;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
    transition: all 0.3s ease;
  }

  .form-select:focus {
    border-color: #0056b3;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    outline: none;
  }

  .form-label {
    color: white;
    font-weight: 600;
  }
</style>
<div class="container-fluid mt-4">
  <div class="row">

    <!-- LEFT: SEARCH BOX -->
    <div class="col-md-9">
      <div class="search-box p-4 shadow-sm bg-white rounded">
        <h2 class="text-center mb-4 text-primary">✈️ Search Flights</h2>
            <input type="hidden" id="search_id">
        <div class="row g-3">
          <!-- Departure City -->
          <div class="col-md-6">
            <h5>Departure City</h5>
            <input type="text" id="dep_Input" class="form-control" placeholder="Start typing a city..." required>
            <ul id="dep_suggestions" class="suggestions"></ul>

            <label for="dep_airport" class="form-label mt-2">Select Airport:</label>
            <select id="dep_airport" class="form-control" required>
              <option value="">-- Select Airport --</option>
            </select>
          </div>

          <!-- Arrival City -->
          <div class="col-md-6">
            <h5>Arrival City</h5>
            <input type="text" id="arr_Input" class="form-control" placeholder="Start typing a city..." required>
            <ul id="arr_suggestions" class="suggestions"></ul>

            <label for="arr_airport" class="form-label mt-2">Select Airport:</label>
            <select id="arr_airport" class="form-control" required>
              <option value="">-- Select Airport --</option>
            </select>
          </div>
        </div>

        <!-- Dates -->
        <div class="row g-3 mt-3">
          <div class="col-md-6">
            <label for="dep_date" class="form-label">Departure Date:</label>
            <input type="date" id="dep_date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label for="arr_date" class="form-label">Return Date:</label>
            <input type="date" id="arr_date" class="form-control" required>
          </div>
        </div>

        <!-- Buttons -->
        <div class="text-center mt-4">
          <button id="searchBtn" class="btn btn-primary px-4 me-2">Search Flights</button>
          <button id="saveBtn" class="btn btn-outline-primary px-4" onclick="saveFilter()">Save Search</button>
          <button id="editBtn" class="btn btn-outline-primary px-4" onclick="updateSearch()">Edit Search</button>
        </div>

        <p id="msg" class="mt-3 text-success text-center"></p>

        <!-- Results -->
        <div id="flightsContainer" class="mt-4"></div>
      </div>
    </div>

    <!-- RIGHT: SAVED SEARCHES SIDEBAR -->
    <div class="col-md-3">
      <div class="p-3 bg-light border rounded shadow-sm h-100">
        <h5 class="text-primary mb-3">Saved Searches</h5>
          <ul id="saved-searches" class="list-group"></ul>

        
      </div>
    </div>
  </div>
</div>
<script>

  const dep_input = document.getElementById("dep_Input");
  const dep_airport = document.getElementById("dep_airport");
  const arr_Input = document.getElementById("arr_Input");
  const arr_airport = document.getElementById("arr_airport");
  const dep_date = document.getElementById("dep_date");
  const arr_date = document.getElementById("arr_date");
  const searchBtn = document.querySelector("button");

  searchBtn.addEventListener("click", async () => {
    const depCode = dep_airport.value;
    const arrCode = arr_airport.value;
    const depDate = dep_date.value; // format: YYYY-MM-DD
    const returnDate = arr_date.value; // optional
    const adults = 1;
    const children = "4,12";

    if (!depCode || !arrCode || !depDate || !returnDate) {
      alert("Please select departure, arrival airports and departure date!");
      return;
    }
    const flights = await fetchFlights(depCode, arrCode, depDate, returnDate, adults, children);

  
  });


  let typingTimer;
  const typingDelay = 600; // wait 600ms after typing stops

  dep_input.addEventListener("keyup", () => {
    var city = dep_input.value.trim();
    var dep_airport = document.getElementById("dep_airport");
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => fetchAirports(city, dep_airport), typingDelay);
  });
  arr_Input.addEventListener("keyup", () => {
    var city = arr_Input.value.trim();
    var arr_airport = document.getElementById("arr_airport");
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => fetchAirports(city, arr_airport), typingDelay);
  });

  async function fetchAirports(city, airportSelect) {

    if (!airportSelect) return;
    if (!city) {
      airportSelect.innerHTML = '<option>-- Type a city name first --</option>';
      return;
    }

    airportSelect.innerHTML = '<option>Loading airports...</option>';

    try {
      const response = await fetch(`/get-airports/?city=${encodeURIComponent(city)}`);
      const data = await response.json();

      airportSelect.innerHTML = "";
      if (data.airports && data.airports.length > 0) {
        data.airports.forEach(airport => {
          const option = document.createElement("option");
          option.value = airport.code;
          option.textContent = `${airport.name} (${airport.code})`;
          airportSelect.appendChild(option);
        });
      } else {
        // ✅ Use safe fallback
        const option = document.createElement("option");
        option.textContent = "No airports found";
        airportSelect.appendChild(option);
      }
    } catch (error) {
      console.error("Error fetching airports:", error);
      airportSelect.innerHTML = '<option>Error fetching data</option>';
    }
  }

  async function fetchFlights(depCode, arrCode, depDate, returnDate, adults, children) {
    const params = new URLSearchParams({
      dep: depCode,
      arr: arrCode,
      dep_date: depDate,
      return_date: returnDate || "",
      adults: adults,
      children: children,
      cabin_class: "PREMIUM_ECONOMY"
    });

    const res = await fetch(`/search-flights/?${params.toString()}`);
    const data = await res.json();
    toggleButton();
   const container = document.getElementById('flightsContainer');
container.innerHTML = ''; // Clear previous content
if (data.data && data.data.flightOffers && data.data.flightOffers.length > 0) {
  for (let offer of data.data.flightOffers) {
    const price = offer.priceBreakdown.total;
    const total = price.units + price.nanos / 1e9;

    const priceGBP = await convertToGBP(total, price.currencyCode);

    const offerDiv = document.createElement('div');
    offerDiv.classList.add('offer', 'mb-4', 'p-3', 'border', 'rounded', 'shadow', 'bg-white');

    const priceEl = document.createElement('h2');
    priceEl.classList.add('text-primary', 'mb-3');
    priceEl.textContent = `Price: ~£${priceGBP.toFixed(2)}`;
    offerDiv.appendChild(priceEl);

    // Create a container for segments with flex
    const segmentsContainer = document.createElement('div');
    segmentsContainer.classList.add('d-flex', 'justify-content-between', 'gap-3'); // flex container
    offerDiv.appendChild(segmentsContainer);

    offer.segments.forEach((segment, index) => {
      const segmentDiv = document.createElement('div');
      segmentDiv.classList.add('segment', 'p-2', 'border', 'rounded', 'flex-fill');

      // Determine segment type
      const segmentType = index === 0 ? 'Outbound' : 'Return';

      const segmentHeader = document.createElement('h4');
      segmentHeader.classList.add('text-primary', 'mb-2');
      segmentHeader.textContent = segmentType;
      segmentDiv.appendChild(segmentHeader);

      // Iterate legs
      segment.legs.forEach((leg) => {
        const legDiv = document.createElement('div');
        legDiv.classList.add('leg', 'mb-3');

        const carrier = leg.carriersData ? leg.carriersData[0] : null;

        legDiv.innerHTML = `
          <div class="d-flex align-items-center mb-2">
            <img src="${carrier?.logo || ''}" alt="${carrier?.name || carrier?.code}" width="50" height="50" class="me-2" />
            <p class="mb-0"><strong>${carrier?.name || 'Unknown Airline'}</strong> (${carrier?.code || ''})</p>
          </div>
          <p><strong>From:</strong> ${leg.departureAirport.name} (${leg.departureAirport.code}) <strong>To:</strong> ${leg.arrivalAirport.name} (${leg.arrivalAirport.code})</p>
          <p><strong>Departure:</strong> ${leg.departureTime} <strong>Arrival:</strong> ${leg.arrivalTime}</p>
          <p><strong>Flight Number:</strong> ${leg.flightInfo.flightNumber}</p>
          <p><strong>Cabin Class:</strong> ${leg.cabinClass}</p>
          <p><strong>Stops:</strong> ${leg.flightInfo?.flightStops || 'NO'}</p>
          <p><strong>Plane Type:</strong> ${leg.flightInfo?.planeType || '-'}</p>
          <p><strong>Segment Time:</strong> ${secondsToHHMMSS(leg.totalTime)}</p>
        `;
        segmentDiv.appendChild(legDiv);
      });

      segmentsContainer.appendChild(segmentDiv);
    });

    container.appendChild(offerDiv);
  }
} else {
  container.innerHTML = '<p class="text-center text-muted">No flight offers available.</p>';
}
  }


  function secondsToHHMMSS(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }


  async function convertToGBP(amount, currencyCode) {
    const response = await fetch(`https://v6.exchangerate-api.com/v6/581d6b20a6a4a3b9f8e716cf/pair/${currencyCode}/GBP`);
    const data = await response.json();
    const rate = data.conversion_rate;
    return amount * rate;
  }


async function saveFilter() {
   
  const dep_airportInput = document.getElementById("dep_airport");
  const arr_airportInput = document.getElementById("arr_airport");
  const departure_city = document.getElementById('dep_Input').value;
  const arrival_city = document.getElementById('arr_Input').value;
  const departure_date = document.getElementById('dep_date').value;
  const return_date = document.getElementById('arr_date').value;
  const dep_airportName = dep_airportInput.options[dep_airportInput.selectedIndex].text;
  const arr_airportName =  arr_airportInput.options[arr_airportInput.selectedIndex].text;
  const departure_airport_code = dep_airportInput.value;
  const arrival_airport_code = arr_airportInput.value;

  if (
  !departure_city ||
  !arrival_city ||
  !departure_date ||
  !return_date ||
  !departure_airport_code ||
  !arrival_airport_code
) {
  alert("Please fill in all fields before saving the search.");
  return;
} 

  const response = await fetch("{% url 'save_filter' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken(),
    },
    body: JSON.stringify({
      departure_city,
      arrival_city,
      departure_date,
      return_date,
      dep_airportName,
      arr_airportName,
      departure_airport_code,
      arrival_airport_code
    })
  });

  const data = await response.json();
  const msg = document.getElementById("msg");
  toggleButton();

  if (response.ok) {
    msg.textContent = data.message;
    msg.classList.remove("text-danger");
    msg.classList.add("text-success");
    loadSavedSearches(); // refresh sidebar
    
  } else {
    msg.textContent = data.error || "Something went wrong.";
    msg.classList.remove("text-success");
    msg.classList.add("text-danger");
  }
}

function updateSearch() {
  
  const searchId = document.getElementById('search_id').value;
  
  if(searchId == ''){
    alert("This search need to save first.");
    return;
  }

  const dep_airportInput = document.getElementById("dep_airport");
  const arr_airportInput = document.getElementById("arr_airport");
  const departure_city = document.getElementById('dep_Input').value;
  const arrival_city = document.getElementById('arr_Input').value;
  const departure_date = document.getElementById('dep_date').value;
  const return_date = document.getElementById('arr_date').value;
  const departure_airport = dep_airportInput.options[dep_airportInput.selectedIndex].text;
  const arrival_airport =  arr_airportInput.options[arr_airportInput.selectedIndex].text;
  const departure_airport_code = dep_airportInput.value;
  const arrival_airport_code = arr_airportInput.value;

  if (
  !departure_city ||
  !arrival_city ||
  !departure_date ||
  !return_date ||
  !departure_airport_code ||
  !arrival_airport_code
) {
  alert("Please fill in all fields before saving the search.");
  return;
} 


  fetch(`/edit-search/${searchId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken('csrftoken') // make sure you include CSRF
    },
      body: JSON.stringify({
      departure_city,
      arrival_city,
      departure_date,
      return_date,
      departure_airport,
      arrival_airport,
      departure_airport_code,
      arrival_airport_code
    })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        loadSavedSearches(); // refresh sidebar
        alert('✅ Search updated successfully!');
        toggleButton()
      
      } else {
        alert('❌ ' + data.message);
        console.error(data.errors);
      }
    })
    .catch(err => console.error('Error:', err));
}

document.addEventListener("DOMContentLoaded", loadSavedSearches);

async function loadSavedSearches() {
  const savedSearchList = document.getElementById("saved-searches");
  savedSearchList.innerHTML = "<li>Loading...</li>";

  try {
    const res = await fetch("/get-saved-searches/");
    if (!res.ok) throw new Error("Failed to load saved searches");
    const data = await res.json();

    savedSearchList.innerHTML = "";
    toggleButton();
    data.forEach(search => {
      const li = document.createElement("li");
      li.classList.add("list-group-item", "list-group-item-action");
      li.textContent = `${search.departureCity} → ${search.arrivalCity} (${search.departureDate})`;
      li.addEventListener("click", () => loadSearchToForm(search));

      

// Right side: icons container
  const iconsDiv = document.createElement("div");
  iconsDiv.classList.add("float-end");

  // Edit icon
  const editIcon = document.createElement("i");
  editIcon.classList.add("fas", "fa-edit", "text-primary", "me-2"); // Font Awesome classes
  editIcon.style.cursor = "pointer";
  editIcon.title = "Edit";
  editIcon.addEventListener("click", (e) => {
    e.stopPropagation(); // Prevent li click
    loadSearchToForm(search, true); // Pass flag for edit mode
  });

  // Delete icon
  const deleteIcon = document.createElement("i");
  deleteIcon.classList.add("fas", "fa-trash-alt", "text-danger");
   deleteIcon.style.cursor = "pointer";
  deleteIcon.title = "Delete";
  deleteIcon.addEventListener("click", (e) => {
    e.stopPropagation();
    deleteSavedSearch(search.id, li);
  });

  // Append icons to icons container
  iconsDiv.appendChild(editIcon);
  iconsDiv.appendChild(deleteIcon);
li.appendChild(iconsDiv);


      savedSearchList.appendChild(li);
    });
  } catch (err) {
    savedSearchList.innerHTML = "<li>Error loading saved searches</li>";
  }
}

async function deleteSavedSearch(searchId, liElement) {
  if (!confirm("Are you sure you want to delete this saved search?")) return;

  try {
    const response = await fetch(`/delete-search/${searchId}/`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": getCSRFToken("csrftoken") // For Django
      }
    });

    if (response.ok) {
      liElement.remove(); // Remove the li from the DOM
      alert("Saved search deleted!");
    } else {
      alert("Failed to delete search.");
    }
  } catch (err) {
    console.error(err);
    alert("Error deleting search.");
  }
}


function loadSearchToForm(search) {
  document.getElementById("dep_Input").value = search.departureCity;
  document.getElementById("arr_Input").value = search.arrivalCity;
  document.getElementById("search_id").value = search.id;
  depAirportSelect = document.getElementById("dep_airport");
  depAirportSelect.innerHTML = '<option value="">-- Select Airport --</option>';
  arrAirportSelect = document.getElementById("arr_airport");
  arrAirportSelect.innerHTML = '<option value="">-- Select Airport --</option>';
// Append options and set selected
 console.log(search);
  const option = document.createElement("option");
  option.value = search.departureAirportCode;
  option.textContent = search.departureAirport;
  
  // Set selected if matches
  option.selected = true;
  depAirportSelect.appendChild(option);
 

// Append options and set selected
 
  const option2 = document.createElement("option");
  option2.value = search.arrivalAirportCode;
  option2.textContent = search.arrivalAirport;
  
  // Set selected if matches
  option2.selected = true;
  arrAirportSelect.appendChild(option2);

  document.getElementById("dep_date").value = search.departureDate;
  document.getElementById("arr_date").value = search.returnDate;
  toggleButton();

}


function toggleButton(){
  const saveBtn = document.getElementById('saveBtn');
  const updateBtn = document.getElementById('editBtn');
  const searchIdInput = document.getElementById('search_id');

    const searchId = searchIdInput.value.trim();
    if (searchId === "" || searchId === null) {
      // No saved search — show Save button
      saveBtn.style.display = "inline-block";
      updateBtn.style.display = "none";
    } else {
      // Editing existing search — show Update button
      saveBtn.style.display = "none";
      updateBtn.style.display = "inline-block";
    }
}


function getCSRFToken() {
  return document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];
}

 


</script>

<!-- index.html content ends here -->
{% endblock %}