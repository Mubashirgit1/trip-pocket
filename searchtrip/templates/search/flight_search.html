{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>City Selector</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    input { width: 300px; padding: 8px; }
    ul {
      border: 1px solid #ccc;
      max-width: 300px;
      list-style: none;
      padding: 0;
      margin-top: 0;
      position: absolute;
      background: white;
      z-index: 100;
    }
    li {
      padding: 8px;
      cursor: pointer;
    }
    li:hover {
      background-color: #eee;
    }
  </style>
</head>
<body>
  
  <h2>Search City for Departure</h2>
  <input type="text" id="dep_Input" placeholder="Start typing a city...">
  <ul id="suggestions"></ul>
 
 <br><br>

  <label for="dep_airport">Select Airport:</label>
  <select id="dep_airport">
    <option value="">-- Select Airport --</option>
  </select>

  <h2>Search City Arrival</h2>
  <input type="text" id="arr_Input" placeholder="Start typing a city...">
  <ul id="suggestions"></ul>
 
 <br><br>

  <label for="arr_airport">Select Airport:</label>
  <select id="arr_airport">
    <option value="">-- Select Airport --</option>
  </select>
  <br><br>
<label for="dep_date">Departure Date:</label>
<input type="date" id="dep_date">

<label for="arr_date">Return Date (optional):</label>
<input type="date" id="arr_date">


<button>Search Flights</button>

  <script>

    const dep_input = document.getElementById("dep_Input");
    const dep_airport = document.getElementById("dep_airport");
    const arr_Input = document.getElementById("arr_Input");
    const arr_airport = document.getElementById("arr_airport");
    const dep_date = document.getElementById("dep_date");
    const arr_date = document.getElementById("arr_date");

    const searchBtn = document.querySelector("button");

    searchBtn.addEventListener("click", async () => {
      const depCode = dep_airport.value;
      const arrCode = arr_airport.value;
      const depDate = dep_date.value; // format: YYYY-MM-DD
      const returnDate = arr_date.value; // optional
      const adults = 1;
      const children = "4,12"; 

      if (!depCode || !arrCode || !depDate) {
        alert("Please select departure, arrival airports and departure date!");
        return;
      }
  const flights = await fetchFlights(depCode, arrCode, depDate, returnDate, adults, children);

     console.log(flights);
     alert("Check console for flight results");
    });


    let typingTimer;
    const typingDelay = 600; // wait 600ms after typing stops

    dep_input.addEventListener("keyup", () => {
      var city = dep_input.value.trim();
      var dep_airport = document.getElementById("dep_airport");
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => fetchAirports(city,dep_airport), typingDelay);
    });
    arr_Input.addEventListener("keyup", () => {
      var city = arr_Input.value.trim();
      var arr_airport = document.getElementById("arr_airport");
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => fetchAirports(city,arr_airport), typingDelay);
    });

    async function fetchAirports(city,airportSelect) {
     
       if (!airportSelect) return; 
      if (!city) {
        airportSelect.innerHTML = '<option>-- Type a city name first --</option>';
        return;
      }

      airportSelect.innerHTML = '<option>Loading airports...</option>';

      try {
        const response = await fetch(`/searchtrip/get-airports/?city=${encodeURIComponent(city)}`);
        const data = await response.json();

        airportSelect.innerHTML = "";
        if (data.airports && data.airports.length > 0) {
          data.airports.forEach(airport => {
            const option = document.createElement("option");
            option.value = airport.code;
            option.textContent = `${airport.name} (${airport.code})`;
            airportSelect.appendChild(option);
          });
        }  else {
          // âœ… Use safe fallback
          const option = document.createElement("option");
          option.textContent = "No airports found";
          airportSelect.appendChild(option);
        }
      } catch (error) {
        console.error("Error fetching airports:", error);
        airportSelect.innerHTML = '<option>Error fetching data</option>';
      }
    }

    async function fetchFlights(depCode, arrCode, depDate, returnDate, adults, children) {
    const params = new URLSearchParams({
        dep: depCode,
        arr: arrCode,
        dep_date: depDate,
        return_date: returnDate || "",
        adults: adults,
        children: children,
        cabin_class: "PREMIUM_ECONOMY"
    });

    const res = await fetch(`/searchtrip/search-flights/?${params.toString()}`);
    const data = await res.json();

    console.log(data);
    return data;
    }


  </script>
</body>
</html>